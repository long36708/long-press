import{p as X,d as B,s as Z,D as m,a as j,S as J,b as F,c as I}from"./styles-0784dbeb.CDCF02WY.js";import{G as tt}from"./graph.BMyGJfMe.js";import{s as x}from"./transform.CqGPC-JM.js";import{W as E,Q as g,aa as et,X as ot,Z as w}from"../app.CjkEncdn.js";import{r as st}from"./index-01f381cb.DwbIP8dC.js";import"./dayjs.min.DZyl58SH.js";import"./layout.JYStOzQh.js";import"./union.DW6JZ5RA.js";import"./framework.DGCt2JJv.js";import"./theme.C8i74vko.js";import"./clone.CbRlTBps.js";import"./pick.RM3lF-2J.js";import"./edges-066a5561.nu1S-cHe.js";import"./createText-ca0c5216.hpYaXz8B.js";import"./line.BLbPSTOH.js";import"./array.DEnAxiAM.js";import"./path.CbwjOpE9.js";import"./point.DWREGWZc.js";const h="rect",C="rectWithTitle",nt="start",it="end",ct="divider",rt="roundedWithTitle",at="note",lt="noteGroup",_="statediagram",dt="state",Et=`${_}-${dt}`,H="transition",St="note",pt="note-edge",Tt=`${H} ${pt}`,_t=`${_}-${St}`,ut="cluster",ft=`${_}-${ut}`,Dt="cluster-alt",bt=`${_}-${Dt}`,U="parent",V="note",At="state",N="----",ht=`${N}${V}`,M=`${N}${U}`,W="fill:none",Y="fill: #333",z="c",q="text",K="normal";let y={},d=0;const yt=function(t){const n=Object.keys(t);for(const e of n)t[e]},gt=function(t,n){return n.db.extract(n.db.getRootDocV2()),n.db.getClasses()};function $t(t){return t==null?"":t.classes?t.classes.join(" "):""}function R(t="",n=0,e="",i=N){const c=e!==null&&e.length>0?`${i}${e}`:"";return`${At}-${t}${c}-${n}`}const A=(t,n,e,i,c,r)=>{const o=e.id,u=$t(i[o]);if(o!=="root"){let p=h;e.start===!0&&(p=nt),e.start===!1&&(p=it),e.type!==m&&(p=e.type),y[o]||(y[o]={id:o,shape:p,description:w.sanitizeText(o,g()),classes:`${u} ${Et}`});const s=y[o];e.description&&(Array.isArray(s.description)?(s.shape=C,s.description.push(e.description)):s.description.length>0?(s.shape=C,s.description===o?s.description=[e.description]:s.description=[s.description,e.description]):(s.shape=h,s.description=e.description),s.description=w.sanitizeTextOrArray(s.description,g())),s.description.length===1&&s.shape===C&&(s.shape=h),!s.type&&e.doc&&(E.info("Setting cluster for ",o,G(e)),s.type="group",s.dir=G(e),s.shape=e.type===j?ct:rt,s.classes=s.classes+" "+ft+" "+(r?bt:""));const T={labelStyle:"",shape:s.shape,labelText:s.description,classes:s.classes,style:"",id:o,dir:s.dir,domId:R(o,d),type:s.type,padding:15};if(T.centerLabel=!0,e.note){const a={labelStyle:"",shape:at,labelText:e.note.text,classes:_t,style:"",id:o+ht+"-"+d,domId:R(o,d,V),type:s.type,padding:15},l={labelStyle:"",shape:lt,labelText:e.note.text,classes:s.classes,style:"",id:o+M,domId:R(o,d,U),type:"group",padding:0};d++;const f=o+M;t.setNode(f,l),t.setNode(a.id,a),t.setNode(o,T),t.setParent(o,f),t.setParent(a.id,f);let S=o,D=a.id;e.note.position==="left of"&&(S=a.id,D=o),t.setEdge(S,D,{arrowhead:"none",arrowType:"",style:W,labelStyle:"",classes:Tt,arrowheadStyle:Y,labelpos:z,labelType:q,thickness:K})}else t.setNode(o,T)}n&&n.id!=="root"&&(E.trace("Setting node ",o," to be child of its parent ",n.id),t.setParent(o,n.id)),e.doc&&(E.trace("Adding nodes children "),xt(t,e,e.doc,i,c,!r))},xt=(t,n,e,i,c,r)=>{E.trace("items",e),e.forEach(o=>{switch(o.stmt){case F:A(t,n,o,i,c,r);break;case m:A(t,n,o,i,c,r);break;case J:{A(t,n,o.state1,i,c,r),A(t,n,o.state2,i,c,r);const u={id:"edge"+d,arrowhead:"normal",arrowTypeEnd:"arrow_barb",style:W,labelStyle:"",label:w.sanitizeText(o.description,g()),arrowheadStyle:Y,labelpos:z,labelType:q,thickness:K,classes:H};t.setEdge(o.state1.id,o.state2.id,u,d),d++}break}})},G=(t,n=I)=>{let e=n;if(t.doc)for(let i=0;i<t.doc.length;i++){const c=t.doc[i];c.stmt==="dir"&&(e=c.value)}return e},Ct=async function(t,n,e,i){E.info("Drawing state diagram (v2)",n),y={},i.db.getDirection();const{securityLevel:c,state:r}=g(),o=r.nodeSpacing||50,u=r.rankSpacing||50;E.info(i.db.getRootDocV2()),i.db.extract(i.db.getRootDocV2()),E.info(i.db.getRootDocV2());const p=i.db.getStates(),s=new tt({multigraph:!0,compound:!0}).setGraph({rankdir:G(i.db.getRootDocV2()),nodesep:o,ranksep:u,marginx:8,marginy:8}).setDefaultEdgeLabel(function(){return{}});A(s,void 0,i.db.getRootDocV2(),p,i.db,!0);let T;c==="sandbox"&&(T=x("#i"+n));const a=c==="sandbox"?x(T.nodes()[0].contentDocument.body):x("body"),l=a.select(`[id="${n}"]`),f=a.select("#"+n+" g");await st(f,s,["barb"],_,n);const S=8;et.insertTitle(l,"statediagramTitleText",r.titleTopMargin,i.db.getDiagramTitle());const D=l.node().getBBox(),L=D.width+S*2,P=D.height+S*2;l.attr("class",_);const O=l.node().getBBox();ot(l,P,L,r.useMaxWidth);const k=`${O.x-S} ${O.y-S} ${L} ${P}`;E.debug(`viewBox ${k}`),l.attr("viewBox",k);const Q=document.querySelectorAll('[id="'+n+'"] .edgeLabel .label');for(const $ of Q){const v=$.getBBox(),b=document.createElementNS("http://www.w3.org/2000/svg",h);b.setAttribute("rx",0),b.setAttribute("ry",0),b.setAttribute("width",v.width),b.setAttribute("height",v.height),$.insertBefore(b,$.firstChild)}},Rt={setConf:yt,getClasses:gt,draw:Ct},Kt={parser:X,db:B,renderer:Rt,styles:Z,init:t=>{t.state||(t.state={}),t.state.arrowMarkerAbsolute=t.arrowMarkerAbsolute,B.clear()}};export{Kt as diagram};
